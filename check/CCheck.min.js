var CCheck=function(){this.ajv=new Ajv({allErrors:!0})};CCheck.prototype.checkSchema=function(e,k){if(!k||!k.schema)throw Error("checkSchema options: a schema must be supplied");var r=this.ajv.compile(k.schema);return r(e)?{status:0,statusText:"SpecIF schema has been checked successfully!"}:{status:971,statusText:"SpecIF schema is violated",responseType:"text",responseText:this.ajv.errorsText(r.errors)}};
CCheck.prototype.checkConstraints=function(e,k){function r(b,f){Array.isArray(b.propertyClasses)&&("resourceClass"==f&&!b["extends"]&&1>b.propertyClasses.length&&g.push({status:976,statusText:"resource class '"+b.id+"' must have at least one property class"}),b.propertyClasses.forEach(function(a){q(e.propertyClasses,a)&&g.push({status:977,statusText:"property class '"+a.id+"' of element '"+b.id+"' must reference an item in 'propertyClasses'"})}))}function u(b,f,a,c){f.forEach(function(d){d[a]&&q(b,
d[a])&&g.push({status:979,statusText:"key '"+a+"' of item with identifier '"+d.id+"' must reference a valid "+c})})}function v(b,f,a){var c=p(e.dataTypes,b.dataType);c&&Array.isArray(f)&&(!(b.multiple||"boolean"!=typeof b.multiple&&c.multiple)&&1<f.length&&g.push({status:983,statusText:a+": neither propertyClass nor dataType allow multiple values"}),f.forEach(function(d){if(Array.isArray(c.enumeration))("string"!=typeof d||q(c.enumeration,{id:d}))&&g.push({status:984,statusText:a+": all values must be an id of the dataTypes' value enumeration"});
else{switch(c.type){case "xs:string":if(!w(d)){g.push({status:985,statusText:a+": all values must be a list (of multi-language objects)"});return}break;default:if("string"!=typeof d){g.push({status:985,statusText:a+": all values must be a string"});return}}switch(c.type){case "xs:boolean":"true"!=d&&"false"!=d&&g.push({status:986,statusText:a+": boolean value is invalid"});break;case "xs:dateTime":0<checkSchema('{"value":"'+d+'"}',{schema:{id:"http://specif.de/v1.1/dateTime/schema#",$schema:"http://json-schema.org/draft-04/schema#",
value:{type:"string",format:"date-time"}}}).status&&g.push({status:986,statusText:a+": value must be a valid date-time string according to ISO 8601"});break;case "xs:anyURI":0<checkSchema('{"value":"'+d+'"}',{schema:{id:"http://specif.de/v1.1/anyURI/schema#",$schema:"http://json-schema.org/draft-04/schema#",value:{type:"string",format:"uri"}}}).status&&g.push({status:986,statusText:a+": value must be a valid URI string according to according to RFC 3986"});break;case "xs:integer":d=parseInt(d);isNaN(d)&&
g.push({status:986,statusText:a+": value is not a valid number"});c.minInclusive&&d<c.minInclusive&&g.push({status:986,statusText:a+": integer value must be larger than "+c.minInclusive});c.maxInclusive&&d>c.maxInclusive&&g.push({status:986,statusText:a+": integer value must be smaller than "+c.maxInclusive});break;case "xs:double":d=parseFloat(d);isNaN(d)&&g.push({status:986,statusText:a+": value is not a valid number"});c.minInclusive&&d<c.minInclusive&&g.push({status:986,statusText:a+": double value must be larger than "+
c.minInclusive});c.maxInclusive&&d>c.maxInclusive&&g.push({status:986,statusText:a+": double value must be smaller than "+c.maxInclusive});break;case "xs:string":Array.isArray(d)?"number"==typeof c.maxLength&&0>k.dontCheck.indexOf("text.length")&&d.forEach(function(l){l.text.length>c.maxLength&&0>k.dontCheck.indexOf("text.length")&&g.push({status:986,statusText:a+": length of string value must not exceed "+c.maxLength})}):g.push({status:986,statusText:a+": value must be a list of multi-language objects"})}}}))}
function x(b,f,a){f.forEach(function(c){function d(h){l=l.concat(h.propertyClasses||[]);"object"==typeof h["extends"]&&d(p(b,h["extends"]))}var l=[],m,n,t=p(b,c[a]);t&&(d(t),Array.isArray(c.properties)&&c.properties.forEach(function(h){m="property with class '"+h["class"].id+"' of instance with identifier '"+c.id+"'";q(l,h["class"])&&g.push({status:987,statusText:m+": class must be listed with the instance class or a parent instance class"});n=p(e.propertyClasses,h["class"]);"object"==typeof n?v(n,
h.values,m):g.push({status:987,statusText:m+" must reference a valid propertyClass"})}))})}function y(b,f,a){Array.isArray(f)&&f.forEach(function(c){q(b,c.resource)&&g.push({status:988,statusText:"hierarchy node with identifier '"+c.id+"' must reference a valid resource"});y(b,c.nodes,a+1)})}function z(b){return{id:b.id,revision:b.revision}}function w(b){if(Array.isArray(b)){for(var f=1<b.length,a=b.length-1;-1<a;a--)if("string"!=typeof b[a].text||f&&("string"!=typeof b[a].language||2>b[a].language.length))return!1;
return!0}return!1}function p(b,f){var a=b.filter(function(c){return c.id==f.id});if(!(1>a.length)){if(1==a.length&&!a[0].revision)return f.revision?void 0:a[0];a.sort(function(c,d){return d.changedAt-c.changedAt});if(!f.revision)return a[0];a=a.filter(function(c){return c.revision==f.revision});if(0<a.length)return a[0]}}function q(b,f){return void 0==p(b,f)}function A(b){var f="";b.forEach(function(a){f+=(f.length?",\n":"")+a.statusText+" ("+status+")"});return f}if(e.specifVersion)return{status:970,
statusText:"This constraint checker does not support any SpecIF version below 1.1"};switch(e.$schema){case "https://specif.de/v1.0/schema.json":case "https://json.schemastore.org/specif-1.0.json":return{status:970,statusText:"This constraint checker does not support SpecIF version 1.0"}}"object"!=typeof k&&(k={});Array.isArray(k.dontCheck)||(k.dontCheck=[]);var g=[];(function(){function b(a){if(Array.isArray(a)&&0<a.length)for(var c,d=a.length-1;-1<d;d--)if(void 0!=a[d].id){a:{for(var l=a[d],m=l.revision||
"",n=f.length-1;-1<n;n--)if(c=f[n].revision||"",f[n].id==l.id&&(c==m||""==c||""==m)){c=!0;break a}c=!1}if(c)return a[d];if((c=b(a[d].enumeration))||(c=b(a[d].nodes)))return c;f.push(z(a[d]))}}var f=[z(e)];[{list:e.dataTypes,name:"dataType or enumerated value"},{list:e.propertyClasses,name:"propertyClass"},{list:e.resourceClasses,name:"resourceClass"},{list:e.statementClasses,name:"statementClass"},{list:e.resources,name:"resource"},{list:e.statements,name:"statement"},{list:e.hierarchies,name:"hierarchy or node"},
{list:e.files,name:"file"}].forEach(function(a){var c=b(a.list);c&&g.push({status:973,statusText:"key of "+a.name+" '"+c.id+"' with revision "+c.revision+" is not unique"})})})();(function(){e.dataTypes.forEach(function(b){switch(b.type){case "xs:double":case "xs:integer":"number"==typeof b.minInclusive&&"number"==typeof b.maxInclusive&&b.minInclusive+1>b.maxInclusive&&g.push({status:974,statusText:"dataType '"+b.id+"': minInclusive must be smaller or equal than maxInclusive"});case "xs:dateTime":case "xs:anyURI":case "xs:string":if(Array.isArray(b.enumeration))if(0<
b.enumeration.length)for(var f=b.enumeration.length-1;-1<f;f--)"xs:string"==b.type?w(b.enumeration[f].value)||g.push({status:974,statusText:"dataType '"+b.id+"' of type 'xs:string' must have enumerated values, each with a list of multi-language texts"}):"string"!=typeof b.enumeration[f].value&&g.push({status:974,statusText:"dataType '"+b.id+"' of type '"+b.type+"' must have enumerated string values"});else g.push({status:974,statusText:"dataType '"+b.id+"' must have at least one enumerated value"})}})})();
(function(){e.propertyClasses.forEach(function(b){q(e.dataTypes,b.dataType)&&g.push({status:975,statusText:"property class with identifier '"+b.id+"' must reference a valid dataType"});v(b,b.values,"property class '"+b.id+"'")})})();(function(){e.resourceClasses.forEach(function(b){r(b,"resourceClass")});u(e.resourceClasses,e.resourceClasses,"extends","resourceClass")})();(function(){var b=e.resourceClasses.concat(e.statementClasses);e.statementClasses.forEach(function(f){r(f);["subjectClasses","objectClasses"].forEach(function(a){a:{var c=
f[a];if(Array.isArray(c)){if(1>c.length){c=!0;break a}for(var d=c.length-1;-1<d;d--)if(q(b,c[d])){c=!0;break a}}c=!1}c&&g.push({status:978,statusText:a+" of class '"+f.id+"' must reference at least one valid resourceClass or statementClass"})})});u(e.statementClasses,e.statementClasses,"extends","statementClass")})();u(e.resourceClasses,e.resources,"class","resourceClass");x(e.resourceClasses,e.resources,"class");(function(){u(e.statementClasses,e.statements,"class","statementClass");var b=e.resources.concat(e.statements),
f=e.resourceClasses.concat(e.statementClasses);e.statements.forEach(function(a,c){var d=p(b,a.subject),l=p(b,a.object);!d&&0>k.dontCheck.indexOf("statement.subject")&&g.push({status:980,statusText:"subject of statement["+c+"] with identifier '"+a.id+"' must reference a valid resource or statement"});!l&&0>k.dontCheck.indexOf("statement.object")&&g.push({status:980,statusText:"object of statement["+c+"] with identifier '"+a.id+"' must reference a valid resource or statement"});var m=p(e.statementClasses,
a["class"]);if(Array.isArray(m.subjectClasses)&&d){var n=[];m.subjectClasses.forEach(function(h){(h=p(f,h))&&n.push(h)});q(n,d["class"])&&g.push({status:981,statusText:"the subject of statement["+c+"] with identifier '"+a.id+"' has a class which is not listed in the subjectClasses of the statement's class"})}if(Array.isArray(m.objectClasses)&&l){var t=[];m.objectClasses.forEach(function(h){(h=p(f,h))&&t.push(h)});q(t,l[["class"]])&&g.push({status:981,statusText:"the object of statement["+c+"] with identifier '"+
a.id+"' has a class which is not listed in the objectClasses of the statement's class"})}});x(e.statementClasses,e.statements,"class")})();y(e.resources,e.hierarchies,0);return 1>g.length?{status:0,statusText:"SpecIF constraints have been checked successfully!"}:{status:972,statusText:"SpecIF constraints are violated",responseType:"text",responseText:A(g)}};